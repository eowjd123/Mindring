name: Deploy Mindring

on:
  push:
    branches:
      - main
      workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ SSH into NHN Cloud and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/ubuntu/mindring

            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
            git pull origin main

            echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            sudo docker stop mindring || true
            sudo docker rm mindring || true
            sudo docker rmi mindring:latest || true

            echo "ğŸ”¨ ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ"
            sudo docker build --no-cache -t mindring:latest -f ./Dockerfile .

            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            sudo docker run -d -p 3000:3000 --env-file .env --name mindring mindring:latest

            echo "âœ… Mindring ë°°í¬ ì™„ë£Œ!"
